<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>fastcgi++: Delayed response</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fastcgi++
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">index</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Delayed response </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="timerTutorial"></a>
Tutorial</h1>
<p>Our goal here will be to make a FastCGI application that responds to clients with some text, waits five seconds and then sends more. We're going to use threading and boost::asio to handle our timer. Your going to need the boost C++ libraries for this. At least version 1.35.0.</p>
<p>All code and data is located in the examples directory of the tarball. You'll have to compile with: <code>pkg-config &ndash;libs &ndash;cflags fastcgi++</code> -lboost_system</p>
<h2><a class="anchor" id="timerError"></a>
Error Logging</h2>
<p>Our first step will be setting up an error logging system. Although requests can log errors directly to the HTTP server error log, I like to have an error logging system that's separate from the library when testing applications. Let's set up a function that takes a c style string and logs it to a file with a timestamp. Since everyone has access to the /tmp directory, I set it up to send error messages to /tmp/errlog. You can change it if you want to.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> error_log(<span class="keyword">const</span> <span class="keywordtype">char</span>* msg)</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">using namespace </span>std;</div>
<div class="line">   <span class="keyword">using namespace </span>boost;</div>
<div class="line">   <span class="keyword">static</span> ofstream error;</div>
<div class="line">   <span class="keywordflow">if</span>(!error.is_open())</div>
<div class="line">   {</div>
<div class="line">      error.open(<span class="stringliteral">&quot;/tmp/errlog&quot;</span>, ios_base::out | ios_base::app);</div>
<div class="line">      error.imbue(locale(error.getloc(), <span class="keyword">new</span> posix_time::time_facet()));</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   error &lt;&lt; <span class="charliteral">&#39;[&#39;</span> &lt;&lt; posix_time::second_clock::local_time() &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; msg &lt;&lt; endl;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="timerRequest"></a>
Request Handler</h2>
<p>Now we need to write the code that actually handles the request. In this examples we still need to derive from <a class="el" href="a00059.html" title="Request handling class">Fastcgipp::Request</a> and define the <a class="el" href="a00059.html#ab20544d056d5f288bca354b8c996e451" title="Response generator.">Fastcgipp::Request::response()</a> function, but also some more. We're also going to need some member data to keep track of our requests execution state, a default constructor to initialize it and a global boost::asio::io_service object. In this example let's just use plain old ISO-8859-1 and pass char as the template parameter.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00110.html" title="Defines the Fastcgipp::Request class.">fastcgi++/request.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;cstring&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/asio.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/thread.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/scoped_ptr.hpp&gt;</span></div>
<div class="line"></div>
<div class="line">boost::asio::io_service io;</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>Timer: <span class="keyword">public</span> <a class="code" href="a00059.html" title="Request handling class">Fastcgipp::Request</a>&lt;char&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">private</span>:</div>
</div><!-- fragment --><p>We'll start with our data to keep track of the execution state and a pointer for our timer object.</p>
<div class="fragment"><div class="line">   <span class="keyword">enum</span> State { START, FINISH } state;</div>
<div class="line">   boost::scoped_ptr&lt;boost::asio::deadline_timer&gt; t;</div>
</div><!-- fragment --><p>Now we can define our response function. It is this function that is called to generate a response for the client. We'll start it off with a switch statement that tests our execution state. It isn't a good idea to define the response() function inline as it is called from numerous spots, but for the examples readability we will make an exception.</p>
<div class="fragment"><div class="line">   <span class="keywordtype">bool</span> response()</div>
<div class="line">   {</div>
<div class="line">      <span class="keywordflow">switch</span>(state)</div>
<div class="line">      {</div>
<div class="line">         <span class="keywordflow">case</span> START:</div>
<div class="line">         {</div>
</div><!-- fragment --><p>First thing we'll do is output our HTTP header. Note the charset=ISO-8859-1. Remember that HTTP headers must be terminated with "\r\n\r\n". NOT just "\n\n".</p>
<div class="fragment"><div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Content-Type: text/html; charset=ISO-8859-1\r\n\r\n&quot;</span>;</div>
</div><!-- fragment --><p>Some standard HTML header output</p>
<div class="fragment"><div class="line">            out &lt;&lt; <span class="stringliteral">&quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=ISO-8859-1&#39; /&gt;&quot;</span>;</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;&lt;title&gt;fastcgi++: Threaded Timer&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span>;</div>
</div><!-- fragment --><p>Output a message saying we are starting the timer</p>
<div class="fragment"><div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Starting Timer...&lt;br /&gt;&quot;</span>;</div>
</div><!-- fragment --><p>If we want to the client to see everything that we just outputted now instead of when the request is complete, we will have to flush the stream buffer as it's just sitting in there now.</p>
<div class="fragment"><div class="line">            out.flush();</div>
</div><!-- fragment --><p>Now let's make a five second timer.</p>
<div class="fragment"><div class="line">            t.reset(<span class="keyword">new</span> boost::asio::deadline_timer(io, boost::posix_time::seconds(5)));</div>
</div><!-- fragment --><p>Now we work with our <a class="el" href="a00059.html#a0f95b51bccf1793a06f80c641f3561e7" title="Accessor for the callback function for dealings outside the fastcgi++ library.">Fastcgipp::Request::callback()</a>. It is a boost::function that takes a <a class="el" href="a00041.html" title="Data structure used to pass messages within the fastcgi++ task management system.">Fastcgipp::Message</a> as a single argument. This callback function will pass the message on to this request thereby having <a class="el" href="a00059.html#ab20544d056d5f288bca354b8c996e451" title="Response generator.">Fastcgipp::Request::response()</a> called function again. The callback function is thread safe. That means you can pass messages back to requests from other threads.</p>
<p>First we'll build the message we want sent back here. Normally the message would be built by whatever is calling the callback, but this is just a simple example. A type of 0 means a FastCGI record and is used internally. All other values we can use ourselves to define different message types (sql queries, file grabs, etc...). In this example we will use type=1 for timer stuff.</p>
<div class="fragment"><div class="line">            <a class="code" href="a00041.html" title="Data structure used to pass messages within the fastcgi++ task management system.">Fastcgipp::Message</a> msg;</div>
<div class="line">            msg.<a class="code" href="a00041.html#aba5936b4703cc3c398bbf0bb9eb6bd4f" title="Type of message. A 0 means FastCGI record. Anything else is open.">type</a>=1;</div>
<div class="line"></div>
<div class="line">            {</div>
<div class="line">               <span class="keywordtype">char</span> cString[] = <span class="stringliteral">&quot;I was passed between two threads!!&quot;</span>;</div>
<div class="line">               msg.<a class="code" href="a00041.html#a93817f3790bbeaf27d4e669ed3ce7179" title="Size of the data section.">size</a>=<span class="keyword">sizeof</span>(cString);</div>
<div class="line">               msg.<a class="code" href="a00041.html#a4467d1b63f295c224943dc1a1ef112ff" title="Pointer to the raw data being passed along with the message.">data</a>.reset(<span class="keyword">new</span> <span class="keywordtype">char</span>[<span class="keyword">sizeof</span>(cString)]);</div>
<div class="line">               std::strncpy(msg.<a class="code" href="a00041.html#a4467d1b63f295c224943dc1a1ef112ff" title="Pointer to the raw data being passed along with the message.">data</a>.get(), cString, <span class="keyword">sizeof</span>(cString));</div>
<div class="line">            }</div>
</div><!-- fragment --><p>Now we can give our callback function to our timer.</p>
<div class="fragment"><div class="line">            t-&gt;async_wait(boost::bind(callback(), msg));</div>
</div><!-- fragment --><p>We need to set our state to FINISH so that when this response is called a second time, we don't repeat this.</p>
<div class="fragment"><div class="line">            state=FINISH;</div>
</div><!-- fragment --><p>Now we will return and allow the task manager to do other things (or sleep if there is nothing to do). We must return false if the request is not yet complete.</p>
<div class="fragment"><div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">         }</div>
</div><!-- fragment --><p>Next step, we define what's done when Fastcgipp::Request::responce() is called a second time.</p>
<div class="fragment"><div class="line">         <span class="keywordflow">case</span> FINISH:</div>
<div class="line">         {</div>
</div><!-- fragment --><p>Whenever <a class="el" href="a00059.html#ab20544d056d5f288bca354b8c996e451" title="Response generator.">Fastcgipp::Request::response()</a> is called, the <a class="el" href="a00041.html" title="Data structure used to pass messages within the fastcgi++ task management system.">Fastcgipp::Message</a> that lead to it's calling is stored in <a class="el" href="a00059.html#a58d17e8dd7ce7290fd9943ad17b38283" title="The message associated with the current handler() call.">Fastcgipp::Request::message</a>.</p>
<div class="fragment"><div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Timer Finished! Our message data was \&quot;&quot;</span> &lt;&lt; message.data.get() &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span>;</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</div>
</div><!-- fragment --><p>And we're basically done defining our response! All we need to do is return a boolean value. Always return true if you are done. This will let apache and the manager know we are done so they can destroy the request and free it's resources.</p>
<div class="fragment"><div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">         }</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">   }</div>
</div><!-- fragment --><p>Now we can define our default constructor.</p>
<div class="fragment"><div class="line"><span class="keyword">public</span>:</div>
<div class="line">   Timer(): state(START) {}</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="timerManager"></a>
Requests Manager</h2>
<p>Now we need to make our main() function. In addition to creating a <a class="el" href="a00039.html" title="General task and protocol management class.">Fastcgipp::Manager</a> object with the new class we made as a template parameter and calling it's handler, we also need to set up our threads and io stuff. This isn't a boost::asio tutorial, check the boost documentation for clarification on it.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00102.html" title="Defines the Fastcgipp::Manager class.">fastcgi++/manager.hpp</a>&gt;</span></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">try</span></div>
<div class="line">   {</div>
<div class="line">      boost::asio::io_service::work w(io);</div>
<div class="line">      boost::thread t(boost::bind(&amp;boost::asio::io_service::run, &amp;io));</div>
<div class="line">      <a class="code" href="a00039.html" title="General task and protocol management class.">Fastcgipp::Manager&lt;Timer&gt;</a> fcgi;</div>
<div class="line">      fcgi.<a class="code" href="a00039.html#a578c8468166d892d1858ad6f4d953d8d" title="General handling function to be called after construction.">handler</a>();</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">catch</span>(std::exception&amp; e)</div>
<div class="line">   {</div>
<div class="line">      error_log(e.what());</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="timerCode"></a>
Full Source Code</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;cstring&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/asio.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/thread.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/scoped_ptr.hpp&gt;</span></div>
<div class="line">boost::asio::io_service io;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00110.html" title="Defines the Fastcgipp::Request class.">fastcgi++/request.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00102.html" title="Defines the Fastcgipp::Manager class.">fastcgi++/manager.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> error_log(<span class="keyword">const</span> <span class="keywordtype">char</span>* msg)</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">using namespace </span>std;</div>
<div class="line">   <span class="keyword">using namespace </span>boost;</div>
<div class="line">   <span class="keyword">static</span> ofstream error;</div>
<div class="line">   <span class="keywordflow">if</span>(!error.is_open())</div>
<div class="line">   {</div>
<div class="line">      error.open(<span class="stringliteral">&quot;/tmp/errlog&quot;</span>, ios_base::out | ios_base::app);</div>
<div class="line">      error.imbue(locale(error.getloc(), <span class="keyword">new</span> posix_time::time_facet()));</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   error &lt;&lt; <span class="charliteral">&#39;[&#39;</span> &lt;&lt; posix_time::second_clock::local_time() &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; msg &lt;&lt; endl;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>Timer: <span class="keyword">public</span> <a class="code" href="a00059.html" title="Request handling class">Fastcgipp::Request</a>&lt;char&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">   <span class="keyword">enum</span> State { START, FINISH } state;</div>
<div class="line"></div>
<div class="line">   boost::scoped_ptr&lt;boost::asio::deadline_timer&gt; t;</div>
<div class="line"></div>
<div class="line">   <span class="keywordtype">bool</span> response()</div>
<div class="line">   {</div>
<div class="line">      <span class="keywordflow">switch</span>(state)</div>
<div class="line">      {</div>
<div class="line">         <span class="keywordflow">case</span> START:</div>
<div class="line">         {</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Content-Type: text/html; charset=ISO-8859-1\r\n\r\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=ISO-8859-1&#39; /&gt;&quot;</span>;</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;&lt;title&gt;fastcgi++: Threaded Timer&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span>;</div>
<div class="line">            </div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Starting Timer...&lt;br /&gt;&quot;</span>;</div>
<div class="line"></div>
<div class="line">            out.flush();</div>
<div class="line"></div>
<div class="line">            t.reset(<span class="keyword">new</span> boost::asio::deadline_timer(io, boost::posix_time::seconds(5)));</div>
<div class="line"></div>
<div class="line">            <a class="code" href="a00041.html" title="Data structure used to pass messages within the fastcgi++ task management system.">Fastcgipp::Message</a> msg;</div>
<div class="line">            msg.<a class="code" href="a00041.html#aba5936b4703cc3c398bbf0bb9eb6bd4f" title="Type of message. A 0 means FastCGI record. Anything else is open.">type</a>=1;</div>
<div class="line"></div>
<div class="line">            {</div>
<div class="line">               <span class="keywordtype">char</span> cString[] = <span class="stringliteral">&quot;I was passed between two threads!!&quot;</span>;</div>
<div class="line">               msg.<a class="code" href="a00041.html#a93817f3790bbeaf27d4e669ed3ce7179" title="Size of the data section.">size</a>=<span class="keyword">sizeof</span>(cString);</div>
<div class="line">               msg.<a class="code" href="a00041.html#a4467d1b63f295c224943dc1a1ef112ff" title="Pointer to the raw data being passed along with the message.">data</a>.reset(<span class="keyword">new</span> <span class="keywordtype">char</span>[<span class="keyword">sizeof</span>(cString)]);</div>
<div class="line">               std::strncpy(msg.<a class="code" href="a00041.html#a4467d1b63f295c224943dc1a1ef112ff" title="Pointer to the raw data being passed along with the message.">data</a>.get(), cString, <span class="keyword">sizeof</span>(cString));</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            t-&gt;async_wait(boost::bind(callback(), msg));</div>
<div class="line"></div>
<div class="line">            state=FINISH;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">case</span> FINISH:</div>
<div class="line">         {</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Timer Finished! Our message data was \&quot;&quot;</span> &lt;&lt; message.data.get() &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span>;</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">         }</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">   }</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">   Timer(): state(START) {}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">try</span></div>
<div class="line">   {</div>
<div class="line">      boost::asio::io_service::work w(io);</div>
<div class="line">      boost::thread t(boost::bind(&amp;boost::asio::io_service::run, &amp;io));</div>
<div class="line"></div>
<div class="line">      <a class="code" href="a00039.html" title="General task and protocol management class.">Fastcgipp::Manager&lt;Timer&gt;</a> fcgi;</div>
<div class="line">      fcgi.<a class="code" href="a00039.html#a578c8468166d892d1858ad6f4d953d8d" title="General handling function to be called after construction.">handler</a>();</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">catch</span>(std::exception&amp; e)</div>
<div class="line">   {</div>
<div class="line">      error_log(e.what());</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 22 2012 20:35:53 for fastcgi++ by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1
</small></address>
</body>
</html>
