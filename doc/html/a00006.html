<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>fastcgi++: Database</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fastcgi++
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">index</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Database </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="databaseTutorial"></a>
Tutorial</h1>
<p>Our goal here will be a FastCGI application that utilizes the SQL facilities of fastcgi++. This example will rely on the MySQL engine of the SQL facilities but can be easily changed to any other. We'll create a simple logging mechanism that stores a few values into a table and then pulls the results out of it.</p>
<p>The process that the SQL facilities use can take some getting used to as it places emphasis on a few key things that most people might not care about. For one, maintaining data types from start to finish is insured. Two, data types are standard data types, not some weird library types (unless you consider the boost::date_time stuff weird). Three, it works with data structures that you control the allocation of. This means the members can be auto-allocated should you want. Four, most importantly, queries can be done asynchronously.</p>
<p>In order to fulfil these requirements we lose a few things. No quick and easy queries based on textual representations of data. Those kinds of features are what we have PHP for. This means that every query has to be prepared and have appropriate data structures built for it's parameters. It was deemed that since a FastCGI script is typically contantly running the same queries over and over, they might as well be prepared.</p>
<p>All code and data is located in the examples directory of the tarball. You'll have to compile with: <code>pkg-config &ndash;libs &ndash;cflags fastcgi++</code></p>
<h2><a class="anchor" id="databaseCreate"></a>
Creating the database</h2>
<p>The first thing we need to do is create a database and table to work with our script. For simplicity's sake, connect to you MySQL server and run these commands.</p>
<pre class="fragment">CREATE DATABASE fastcgipp;
USE fastcgipp;
CREATE TABLE logs (ipAddress VARBINARY(16) NOT NULL, timeStamp TIMESTAMP NOT NULL,
sessionId BINARY(12) NOT NULL UNIQUE, referral TEXT) CHARACTER SET="utf8";
GRANT ALL PRIVILEGES ON fastcgipp.* TO 'fcgi'@'localhost' IDENTIFIED BY 'databaseExample';
</pre><p>Note that if your not connecting to localhost, then make sure to change the above accordingly.</p>
<h2><a class="anchor" id="databaseError"></a>
Error Logging</h2>
<p>Our next step will be setting up an error logging system. Although requests can log errors directly to the HTTP server error log, I like to have an error logging system that's separate from the library when testing applications. Let's set up a function that takes a c style string and logs it to a file with a timestamp. Since everyone has access to the /tmp directory, I set it up to send error messages to /tmp/errlog. You can change it if you want to.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/scoped_ptr.hpp&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00105.html" title="Declares the ASql::MySQL namespace.">asql/mysql.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00102.html" title="Defines the Fastcgipp::Manager class.">fastcgi++/manager.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00110.html" title="Defines the Fastcgipp::Request class.">fastcgi++/request.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> error_log(<span class="keyword">const</span> <span class="keywordtype">char</span>* msg)</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">using namespace </span>std;</div>
<div class="line">   <span class="keyword">using namespace </span>boost;</div>
<div class="line">   <span class="keyword">static</span> ofstream error;</div>
<div class="line">   <span class="keywordflow">if</span>(!error.is_open())</div>
<div class="line">   {</div>
<div class="line">      error.open(<span class="stringliteral">&quot;/tmp/errlog&quot;</span>, ios_base::out | ios_base::app);</div>
<div class="line">      error.imbue(locale(error.getloc(), <span class="keyword">new</span> posix_time::time_facet()));</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   error &lt;&lt; <span class="charliteral">&#39;[&#39;</span> &lt;&lt; posix_time::second_clock::local_time() &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; msg &lt;&lt; endl;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="databaseSqlSet"></a>
Query Data Structure</h2>
<p>At this point we need to define the data structures that will contain the results and parameters for our queries. In this example the insert and select queries will both deal with the same set of fields so we only need to create one structure. To make a data structure usable with the SQL facilities it must define two functions internally as explained in <a class="el" href="a00064.html">ASql::Data::Set</a>. By defining these function we turn the structure into a sort of container in the eyes of the SQL facilities.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>Log</div>
<div class="line">{</div>
</div><!-- fragment --><p>First let's define our actual data elements in the structure. Unless we are fetching/sending a binary structure we must use one of the typedefed types in <a class="el" href="a00115.html" title="Defines data types and conversion techniques standard to the fastcgipp SQL facilities.">ASql::Data</a>. We use <a class="el" href="a00007.html" title="Efficiently stores IPv6 addresses.">Fastcgipp::Http::Address</a> and <a class="el" href="a00062.html" title="Defines ID values for HTTP sessions.">Fastcgipp::Http::SessionId</a> as a fixed width fields matching up with a plain old data structure. It will be stored in the table as raw binary data.</p>
<p>As you can see, one of our values has the ability to contain null values. This capability comes from the <a class="el" href="a00043.html" title="Class for adding null capabilities to any type. Needed for SQL queries involving.">ASql::Data::Nullable</a> template class. See also <a class="el" href="a00044.html" title="Class for adding null capabilities to character arrays.">ASql::Data::NullableArray</a>.</p>
<p>Note we are in a wchar_t environment(). and we are accordingly using <a class="el" href="a00115.html#af61ba20752795f6cd31f91cba31abd6e">ASql::Data::WtextN</a> instead of <a class="el" href="a00115.html#a2cb061cd4a4c36a45ccfd019dc3d163f">ASql::Data::TextN</a>. Since our SQL table and connection is in utf-8, all data is code converted for you upon reception.</p>
<p>Our reason for using <a class="el" href="a00062.html" title="Defines ID values for HTTP sessions.">Fastcgipp::Http::SessionId</a> is merely that it provides a good fixed binary data array that happens to have iostream inserter/extractor operators to/from base64. Also the default constructor randomly generates a value.</p>
<div class="fragment"><div class="line">   <a class="code" href="a00007.html" title="Efficiently stores IPv6 addresses.">Fastcgipp::Http::Address</a> ipAddress;</div>
<div class="line">   <a class="code" href="a00115.html#a0977eb1d32f5887cf04719fdd2189642">ASql::Data::Datetime</a> timestamp;</div>
<div class="line">   <a class="code" href="a00062.html" title="Defines ID values for HTTP sessions.">Fastcgipp::Http::SessionId</a> sessionId;</div>
<div class="line">   <a class="code" href="a00043.html" title="Class for adding null capabilities to any type. Needed for SQL queries involving.">ASql::Data::WtextN</a> referral;</div>
</div><!-- fragment --><p>The following macro provides a method of indexing the data in our structure. It communicates type information, data location, and size to the SQL facilities. For most cases simply returning the object itself will suffice. This is accomplished through the appropriate constructor in <a class="el" href="a00032.html" title="Stores on index value from a Set.">ASql::Data::Index</a>. Exceptional cases are when a fixed length char[] is returned as that requires a size parameter and any of the templated constructors as they merely read/write raw binary data with the table based on a field length matching the types size.</p>
<div class="fragment"><div class="line">   <a class="code" href="a00093.html#ac54334c6f5bcdb3904f7d45896aca042" title="Build the appropriate function to make a Data::Set compatible data structure.">ASQL_BUILDSET</a>(\</div>
<div class="line">      (<a class="code" href="a00032.html" title="Stores on index value from a Set.">ASql::Data::Index</a>(ipAddress))\</div>
<div class="line">      (timestamp)\</div>
<div class="line">      (<a class="code" href="a00032.html" title="Stores on index value from a Set.">ASql::Data::Index</a>(sessionId))\</div>
<div class="line">      (referral))</div>
<div class="line">};</div>
</div><!-- fragment --><p>We also need to define a structure for the parameter of our update statement</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>IpAddress: <span class="keyword">public</span> <a class="code" href="a00064.html">ASql::Data::Set</a></div>
<div class="line">{</div>
<div class="line">   <a class="code" href="a00007.html" title="Efficiently stores IPv6 addresses.">Fastcgipp::Http::Address</a> data;</div>
<div class="line">   <a class="code" href="a00093.html#ac54334c6f5bcdb3904f7d45896aca042" title="Build the appropriate function to make a Data::Set compatible data structure.">ASQL_BUILDSET</a>((<a class="code" href="a00032.html" title="Stores on index value from a Set.">ASql::Data::Index</a>(data)))</div>
<div class="line">};</div>
</div><!-- fragment --><p>Be sure to read the documentation at <a class="el" href="a00064.html">ASql::Data::Set</a> to fully understand what just happened.</p>
<h2><a class="anchor" id="databaseRequest"></a>
Request Handler</h2>
<p>Now we need to write the code that actually handles the request. This example will be a little bit more complicated than most, but for starters, let's decide on characters sets. Let's go with utf-8 with this one; so pass wchar_t as our template parameter.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Database: <span class="keyword">public</span> <a class="code" href="a00059.html" title="Request handling class">Fastcgipp::Request</a>&lt;wchar_t&gt;</div>
<div class="line">{</div>
</div><!-- fragment --><p>First things first, we are going to statically build our queries so that all requests can access them. Let's make some simple strings for our SQL queries.</p>
<div class="fragment"><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> insertStatementString[];</div>
<div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> updateStatementString[];</div>
<div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> selectStatementString[];</div>
</div><!-- fragment --><p>Next we'll define our SQL connection object and two SQL statement objects. We'll define them from the <a class="el" href="a00116.html" title="Defines classes and functions relating to MySQL querying.">ASql::MySQL</a> namespace but they can easily be redefined from another SQL engine and maintain the same interface. This way if you change SQL engines, you needn't change your code much at all. Certainly all data types will remain consistent.</p>
<div class="fragment"><div class="line">   <span class="keyword">static</span> <a class="code" href="a00015.html" title="Connection to a MySQL database.">ASql::MySQL::Connection</a> sqlConnection;</div>
<div class="line">   <span class="keyword">static</span> <a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> insertStatement;</div>
<div class="line">   <span class="keyword">static</span> <a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> updateStatement;</div>
<div class="line">   <span class="keyword">static</span> <a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> selectStatement;</div>
</div><!-- fragment --><p>Now we need a status indication variable for the request;</p>
<div class="fragment"><div class="line">   <span class="keyword">enum</span> Status { START, FETCH } status;</div>
</div><!-- fragment --><p>We need a container to use for out Log objects.</p>
<div class="fragment"><div class="line">   <span class="keyword">typedef</span> std::vector&lt;Log&gt; LogContainer;</div>
</div><!-- fragment --><p>Now we declare our response function as usual.</p>
<div class="fragment"><div class="line">   <span class="keywordtype">bool</span> response();</div>
</div><!-- fragment --><p>The following object handles all data associated with the actual queries. It provides a mechanism for controlling the scope of all data required to execute the SQL statements. Be sure to read the documentation associated with the class.</p>
<div class="fragment"><div class="line">   <a class="code" href="a00048.html" title="Class for storing query data to be passed to and retrieved from statements.">ASql::Query&lt;void, ASql::Data::STLSetContainer&lt;LogContainer&gt;</a> &gt; m_query;</div>
<div class="line"><span class="keyword">public</span>:</div>
</div><!-- fragment --><p>The constructor sets our status indicator.</p>
<div class="fragment"><div class="line">   Database(): status(START) {}</div>
</div><!-- fragment --><p>Here we'll declare a static function to handle initialization of static data.</p>
<div class="fragment"><div class="line">   <span class="keyword">static</span> <span class="keywordtype">void</span> initSql();</div>
<div class="line">};</div>
</div><!-- fragment --><p>Now we need to do some basic initialization of our static data. The strings are straightforward. The order of question marks must match exactly to the index order of the data structure they will be read from. In this case Log. For the connection and statement objects we'll call their basic constructors that don't really initialize them.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> Database::insertStatementString[] = <span class="stringliteral">&quot;INSERT INTO logs (ipAddress, timeStamp, sessionId, \ </span></div>
<div class="line"><span class="stringliteral">referral) VALUE(?, ?, ?, ?)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> Database::updateStatementString[] = <span class="stringliteral">&quot;UPDATE logs SET timeStamp=SUBTIME(timeStamp, \</span></div>
<div class="line"><span class="stringliteral">&#39;01:00:00&#39;) WHERE ipAddress=?&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> Database::selectStatementString[] = <span class="stringliteral">&quot;SELECT SQL_CALC_FOUND_ROWS ipAddress, timeStamp, \</span></div>
<div class="line"><span class="stringliteral">sessionId, referral FROM logs ORDER BY timeStamp DESC LIMIT 10&quot;</span>;</div>
</div><!-- fragment --><p>The next line initializes the database connection and decides how many concurrent SQL queries can be operating. Keep in mind that this doesn't dictate how many queries can be queued up, but more how many queues there are. When you queue up a query to be executed it always puts it in the smallest queue.</p>
<div class="fragment"><div class="line"><a class="code" href="a00015.html" title="Connection to a MySQL database.">ASql::MySQL::Connection</a> Database::sqlConnection(4);</div>
<div class="line"><a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> Database::insertStatement(Database::sqlConnection);</div>
<div class="line"><a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> Database::updateStatement(Database::sqlConnection);</div>
<div class="line"><a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> Database::selectStatement(Database::sqlConnection);</div>
</div><!-- fragment --><p>Now we'll declare the function to initialize our static data</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Database::initSql()</div>
<div class="line">{</div>
</div><!-- fragment --><p>Since we didn't use the full constructor on our connection object, we need to actually connect it. See <a class="el" href="a00015.html#a5f45a64e1c577b402338379eff677a3d">ASql::MySQL::Connection::connect()</a> for details.</p>
<div class="fragment"><div class="line">   sqlConnection.connect(<span class="stringliteral">&quot;localhost&quot;</span>, <span class="stringliteral">&quot;fcgi&quot;</span>, <span class="stringliteral">&quot;databaseExample&quot;</span>, <span class="stringliteral">&quot;fastcgipp&quot;</span>, 0, 0, 0, <span class="stringliteral">&quot;utf8&quot;</span>);</div>
</div><!-- fragment --><p>Now we initialize our insert and select statements. We pass the init functions any Log object (default constructed will do) wrapped by a SQL::Data::Set object so it can use the derived functions to build itself around it's structure. The <a class="el" href="a00065.html" title="Wraps a Set object around an new auto-allocated dataset of type T.">ASql::Data::SetBuilder</a> class is used to turn our Log class into a Data::Set derivation. <a class="el" href="a00033.html" title="Wraps a Set object around an new auto-allocated individual object of type T.">ASql::Data::IndySetBuilder</a> turns any data type into a Data::Set of size 1. We pass a null pointer to the associated parameters/results spot if the statement doesn't actually have any. Obviously an insert will always pass a null pointer to the results set whereas a select would often have both parameters and results. See <a class="el" href="a00077.html#a847a2d16d72c36303858741f262cb6f4" title="Initialize statement.">ASql::MySQL::Statement::init()</a> for details.</p>
<div class="fragment"><div class="line">   <span class="keyword">const</span> <a class="code" href="a00065.html" title="Wraps a Set object around an new auto-allocated dataset of type T.">ASql::Data::SetBuilder&lt;Log&gt;</a> log;</div>
<div class="line">   <span class="keyword">const</span> IpAddress addy;</div>
<div class="line">   insertStatement.init(insertStatementString, <span class="keyword">sizeof</span>(insertStatementString), &amp;log, 0);</div>
<div class="line">   updateStatement.init(updateStatementString, <span class="keyword">sizeof</span>(insertStatementString), &amp;addy, 0);</div>
<div class="line">   selectStatement.init(selectStatementString, <span class="keyword">sizeof</span>(selectStatementString), 0, &amp;log);</div>
</div><!-- fragment --><p>By calling this function we initialize the thread/threads that will handle SQL queries.</p>
<div class="fragment"><div class="line">   sqlConnection.start();</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now for the actual response.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="a00059.html#ab20544d056d5f288bca354b8c996e451" title="Response generator.">Database::response</a>()</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">using namespace </span>Fastcgipp;</div>
<div class="line">   <span class="keywordflow">switch</span>(status)</div>
<div class="line">   {</div>
<div class="line">      <span class="keywordflow">case</span> START:</div>
<div class="line">      {</div>
</div><!-- fragment --><p>Now we set up our <a class="el" href="a00048.html" title="Class for storing query data to be passed to and retrieved from statements.">ASql::Query</a> object for use with the statement and run it. Again, be sure to read the doc for the class. We set the callback function to the callback object in the <a class="el" href="a00059.html" title="Request handling class">Fastcgipp::Request</a> class.</p>
<div class="fragment"><div class="line">         m_query.createResults();</div>
<div class="line">         m_query.setCallback(boost::bind(callback(), <a class="code" href="a00041.html" title="Data structure used to pass messages within the fastcgi++ task management system.">Fastcgipp::Message</a>(1)));</div>
<div class="line">         m_query.enableRows(<span class="keyword">true</span>);</div>
<div class="line">         selectStatement.queue(m_query);</div>
</div><!-- fragment --><p>Now we set our status to indicate we are fetching the data from the SQL source. We return false to indicate that the request is not yet complete, just relinquishing the computer.</p>
<div class="fragment"><div class="line">         status=FETCH;</div>
<div class="line">         <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">      }</div>
</div><!-- fragment --><p>So now we have been called again and our query is complete, let's send'er to the client. The following should be pretty straight forward if you've done the other tutorials.</p>
<div class="fragment"><div class="line">      <span class="keywordflow">case</span> FETCH:</div>
<div class="line">      {</div>
<div class="line">         out &lt;&lt; <span class="stringliteral">&quot;Content-Type: text/html; charset=utf-8\r\n\r\n\</span></div>
<div class="line"><span class="stringliteral">&lt;!DOCTYPE html PUBLIC &#39;-//W3C//DTD XHTML 1.0 Strict//EN&#39; &#39;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39; xml:lang=&#39;en&#39; lang=&#39;en&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=utf-8&#39; /&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;title&gt;fastcgi++: SQL Database example&lt;/title&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;h2&gt;Showing &quot;</span> &lt;&lt; selectSet-&gt;size() &lt;&lt; <span class="stringliteral">&quot; results out of &quot;</span> &lt;&lt; m_query.rows() &lt;&lt; <span class="stringliteral">&quot;&lt;/h2&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;table&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;tr&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&lt;b&gt;IP Address&lt;/b&gt;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&lt;b&gt;Timestamp&lt;/b&gt;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&lt;b&gt;Session ID&lt;/b&gt;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&lt;b&gt;Referral&lt;/b&gt;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;/tr&gt;\n&quot;</span>;</div>
</div><!-- fragment --><p>Regarding the above, selectSet-&gt;size() will give us the number of results post LIMIT whereas *rows will tell us the results pre LIMIT due to the use of SQL_CALC_FOUND_ROWS.</p>
<p>Now we'll just iterate through our <a class="el" href="a00067.html" title="Base class for containers of Data::Set objects to be used for result/parameter data in SQL queries...">ASql::Data::SetContainer</a> and show the results in a table.</p>
<div class="fragment"><div class="line">         <span class="keywordflow">for</span>(LogContainer::iterator it(selectSet-&gt;begin()); it!=selectSet-&gt;end(); ++it)</div>
<div class="line">         {</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;\</span></div>
<div class="line"><span class="stringliteral">         &lt;tr&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&quot;</span> &lt;&lt; it-&gt;ipAddress &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&quot;</span> &lt;&lt; it-&gt;timestamp &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&quot;</span> &lt;&lt; it-&gt;sessionId &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&quot;</span> &lt;&lt; encoding(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca42e00febc19b44c59cfdde409c8a7cb6">HTML</a>) &lt;&lt; it-&gt;referral &lt;&lt; encoding(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca1824f8debfcb8164867fd6a229a017a2">NONE</a>) &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;/tr&gt;\n&quot;</span>;</div>
<div class="line">         }</div>
<div class="line"></div>
<div class="line">         out &lt;&lt; <span class="stringliteral">&quot;\</span></div>
<div class="line"><span class="stringliteral">      &lt;/table&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;p&gt;&lt;a href=&#39;database.fcgi&#39;&gt;Refer Me&lt;/a&gt;&lt;/p&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;/html&gt;&quot;</span>;</div>
</div><!-- fragment --><p>So now one last thing to do in the response is log this request. The beauty of our <a class="el" href="a00048.html" title="Class for storing query data to be passed to and retrieved from statements.">ASql::Query</a> is that we can queue the SQL insert statement up, return from here and have the request completed and destroyed before the SQL statement is even complete. We needn't worry about sefaulting.</p>
<p>So here we go, let's build a Log structure and insert it into the database. We're also going to make is so that if the referer is empty, we'll make the value is NULL instead of just an empty string. Keep in mind that the default constructor for sessionId was called and randomly generated one.</p>
<p>By calling reset on m_query we basically recycle it for use a second time around. Notice the call to keepAlive to ensure that the query is not cancelled when the query object goes out of scope.</p>
<div class="fragment"><div class="line">         <a class="code" href="a00048.html" title="Class for storing query data to be passed to and retrieved from statements.">ASql::Query&lt;ASql::Data::SetBuilder&lt;Log&gt;</a>, <span class="keywordtype">void</span>&gt; insertQuery;</div>
<div class="line">         insertQuery.createParameters();</div>
<div class="line">         insertQuery.<a class="code" href="a00056.html#a2a3777584fa3a4124a039bc9adf3c7d0" title="Set true if you want the query to not be cancelled when the original object is destroyed.">keepAlive</a>(<span class="keyword">true</span>);</div>
<div class="line">         insertQuery.<a class="code" href="a00056.html#a5ff5ddd8e8f3a624753391ef3a0b4ed3" title="Return a void pointer to the parameter set.">parameters</a>()-&gt;data.ipAddress = environment().remoteAddress;</div>
<div class="line">         insertQuery.<a class="code" href="a00056.html#a5ff5ddd8e8f3a624753391ef3a0b4ed3" title="Return a void pointer to the parameter set.">parameters</a>()-&gt;data.timestamp = boost::posix_time::second_clock::universal_time();</div>
<div class="line">         <span class="keywordflow">if</span>(environment().referer.size())</div>
<div class="line">            insertQuery.<a class="code" href="a00056.html#a5ff5ddd8e8f3a624753391ef3a0b4ed3" title="Return a void pointer to the parameter set.">parameters</a>()-&gt;data.referral = environment().referer;</div>
</div><!-- fragment --><p>Above we built a query object for our insert statement. Now let's build a fun little query for our update statement. This second query will take all timestamps associated with the clients address and subtract one hour from them.</p>
<div class="fragment"><div class="line">         <a class="code" href="a00048.html" title="Class for storing query data to be passed to and retrieved from statements.">ASql::Query&lt;IpAddress, void&gt;</a> updateQuery;</div>
<div class="line">         updateQuery.createParameters().data = environment().remoteAddress;</div>
<div class="line">         updateQuery.<a class="code" href="a00056.html#a2a3777584fa3a4124a039bc9adf3c7d0" title="Set true if you want the query to not be cancelled when the original object is destroyed.">keepAlive</a>(<span class="keyword">true</span>);</div>
</div><!-- fragment --><p>Now that we have a second query, we can put the two together into a transaction.</p>
<div class="fragment"><div class="line">         <a class="code" href="a00082.html" title="Build a series of queries into a transaction.">ASql::MySQL::Transaction</a> transaction;</div>
<div class="line">         transaction.<a class="code" href="a00082.html#ae0b6f182abf8e73c74b42e22280ce3ba" title="Add a query to the transaction.">push</a>(insertQuery, insertStatement);</div>
<div class="line">         transaction.<a class="code" href="a00082.html#ae0b6f182abf8e73c74b42e22280ce3ba" title="Add a query to the transaction.">push</a>(updateQuery, updateStatement);</div>
<div class="line">         transaction.<a class="code" href="a00082.html#a29d61d0790664a9d801317951435f4b9" title="Initiate the transaction.">start</a>();</div>
</div><!-- fragment --><p>Now let's get our of here. Return a true and the request is completed and destroyed.</p>
<div class="fragment"><div class="line">         <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">      }</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="databaseManager"></a>
Requests Manager</h2>
<p>Now we need to make our main() function. Really all one needs to do is create a <a class="el" href="a00039.html" title="General task and protocol management class.">Fastcgipp::Manager</a> object with the new class we made as a template parameter, then call it's handler. Let's go one step further though and set up a try/catch loop in case we get any exceptions and log them with our error_log function. As an extra this time around we will call Database::initSql() to initialize the static data.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/scoped_ptr.hpp&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00105.html" title="Declares the ASql::MySQL namespace.">asql/mysql.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00102.html" title="Defines the Fastcgipp::Manager class.">fastcgi++/manager.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00110.html" title="Defines the Fastcgipp::Request class.">fastcgi++/request.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> error_log(<span class="keyword">const</span> <span class="keywordtype">char</span>* msg)</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">using namespace </span>std;</div>
<div class="line">   <span class="keyword">using namespace </span>boost;</div>
<div class="line">   <span class="keyword">static</span> ofstream error;</div>
<div class="line">   <span class="keywordflow">if</span>(!error.is_open())</div>
<div class="line">   {</div>
<div class="line">      error.open(<span class="stringliteral">&quot;/tmp/errlog&quot;</span>, ios_base::out | ios_base::app);</div>
<div class="line">      error.imbue(locale(error.getloc(), <span class="keyword">new</span> posix_time::time_facet()));</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   error &lt;&lt; <span class="charliteral">&#39;[&#39;</span> &lt;&lt; posix_time::second_clock::local_time() &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; msg &lt;&lt; endl;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>Log</div>
<div class="line">{</div>
<div class="line">   <a class="code" href="a00007.html" title="Efficiently stores IPv6 addresses.">Fastcgipp::Http::Address</a> ipAddress;</div>
<div class="line">   <a class="code" href="a00115.html#a0977eb1d32f5887cf04719fdd2189642">ASql::Data::Datetime</a> timestamp;</div>
<div class="line">   <a class="code" href="a00062.html" title="Defines ID values for HTTP sessions.">Fastcgipp::Http::SessionId</a> sessionId;</div>
<div class="line">   <a class="code" href="a00043.html" title="Class for adding null capabilities to any type. Needed for SQL queries involving.">ASql::Data::WtextN</a> referral;</div>
<div class="line"></div>
<div class="line">   <a class="code" href="a00093.html#ac54334c6f5bcdb3904f7d45896aca042" title="Build the appropriate function to make a Data::Set compatible data structure.">ASQL_BUILDSET</a>(\</div>
<div class="line">      (<a class="code" href="a00032.html" title="Stores on index value from a Set.">ASql::Data::Index</a>(ipAddress))\</div>
<div class="line">      (timestamp)\</div>
<div class="line">      (<a class="code" href="a00032.html" title="Stores on index value from a Set.">ASql::Data::Index</a>(sessionId))\</div>
<div class="line">      (referral))</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>IpAddress: <span class="keyword">public</span> <a class="code" href="a00064.html">ASql::Data::Set</a></div>
<div class="line">{</div>
<div class="line">   <a class="code" href="a00007.html" title="Efficiently stores IPv6 addresses.">Fastcgipp::Http::Address</a> data;</div>
<div class="line">   <a class="code" href="a00093.html#ac54334c6f5bcdb3904f7d45896aca042" title="Build the appropriate function to make a Data::Set compatible data structure.">ASQL_BUILDSET</a>((<a class="code" href="a00032.html" title="Stores on index value from a Set.">ASql::Data::Index</a>(data)))</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>Database: <span class="keyword">public</span> <a class="code" href="a00059.html" title="Request handling class">Fastcgipp::Request</a>&lt;wchar_t&gt;</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> insertStatementString[];</div>
<div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> updateStatementString[];</div>
<div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> selectStatementString[];</div>
<div class="line"></div>
<div class="line">   <span class="keyword">static</span> <a class="code" href="a00015.html" title="Connection to a MySQL database.">ASql::MySQL::Connection</a> sqlConnection;</div>
<div class="line">   <span class="keyword">static</span> <a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> insertStatement;</div>
<div class="line">   <span class="keyword">static</span> <a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> updateStatement;</div>
<div class="line">   <span class="keyword">static</span> <a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> selectStatement;</div>
<div class="line"></div>
<div class="line">   <span class="keyword">enum</span> Status { START, FETCH } status;</div>
<div class="line"></div>
<div class="line">   <span class="keyword">typedef</span> std::vector&lt;Log&gt; LogContainer;</div>
<div class="line"></div>
<div class="line">   <span class="keywordtype">bool</span> response();</div>
<div class="line"></div>
<div class="line">   <a class="code" href="a00048.html" title="Class for storing query data to be passed to and retrieved from statements.">ASql::Query&lt;void, ASql::Data::STLSetContainer&lt;LogContainer&gt;</a> &gt; m_query;</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">   Database(): status(START) {}</div>
<div class="line">   <span class="keyword">static</span> <span class="keywordtype">void</span> initSql();</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> Database::insertStatementString[] = <span class="stringliteral">&quot;INSERT INTO logs (ipAddress, timeStamp, sessionId, referral) VALUE(?, ?, ?, ?)&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> Database::updateStatementString[] = <span class="stringliteral">&quot;UPDATE logs SET timeStamp=SUBTIME(timeStamp, &#39;01:00:00&#39;) WHERE ipAddress=?&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> Database::selectStatementString[] = <span class="stringliteral">&quot;SELECT SQL_CALC_FOUND_ROWS ipAddress, timeStamp, sessionId, referral FROM logs ORDER BY timeStamp DESC LIMIT 10&quot;</span>;</div>
<div class="line"></div>
<div class="line"><a class="code" href="a00015.html" title="Connection to a MySQL database.">ASql::MySQL::Connection</a> Database::sqlConnection(4);</div>
<div class="line"><a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> Database::insertStatement(Database::sqlConnection);</div>
<div class="line"><a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> Database::updateStatement(Database::sqlConnection);</div>
<div class="line"><a class="code" href="a00077.html" title="MySQL query statement.">ASql::MySQL::Statement</a> Database::selectStatement(Database::sqlConnection);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> Database::initSql()</div>
<div class="line">{</div>
<div class="line">   sqlConnection.connect(<span class="stringliteral">&quot;localhost&quot;</span>, <span class="stringliteral">&quot;fcgi&quot;</span>, <span class="stringliteral">&quot;databaseExample&quot;</span>, <span class="stringliteral">&quot;fastcgipp&quot;</span>, 0, 0, 0, <span class="stringliteral">&quot;utf8&quot;</span>);</div>
<div class="line">   <span class="keyword">const</span> <a class="code" href="a00065.html" title="Wraps a Set object around an new auto-allocated dataset of type T.">ASql::Data::SetBuilder&lt;Log&gt;</a> log;</div>
<div class="line">   <span class="keyword">const</span> IpAddress addy;</div>
<div class="line">   insertStatement.init(insertStatementString, <span class="keyword">sizeof</span>(insertStatementString)-1, &amp;log, 0);</div>
<div class="line">   updateStatement.init(updateStatementString, <span class="keyword">sizeof</span>(updateStatementString)-1, &amp;addy, 0);</div>
<div class="line">   selectStatement.init(selectStatementString, <span class="keyword">sizeof</span>(selectStatementString)-1, 0, &amp;log);</div>
<div class="line">   sqlConnection.start();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> Database::response()</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">using namespace </span>Fastcgipp;</div>
<div class="line">   <span class="keywordflow">switch</span>(status)</div>
<div class="line">   {</div>
<div class="line">      <span class="keywordflow">case</span> START:</div>
<div class="line">      {</div>
<div class="line">         m_query.createResults();</div>
<div class="line">         m_query.setCallback(boost::bind(callback(), <a class="code" href="a00041.html" title="Data structure used to pass messages within the fastcgi++ task management system.">Fastcgipp::Message</a>(1)));</div>
<div class="line">         m_query.enableRows();</div>
<div class="line">         selectStatement.queue(m_query);</div>
<div class="line">         status=FETCH;</div>
<div class="line">         <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">case</span> FETCH:</div>
<div class="line">      {</div>
<div class="line">         out &lt;&lt; <span class="stringliteral">&quot;Content-Type: text/html; charset=utf-8\r\n\r\n\</span></div>
<div class="line"><span class="stringliteral">&lt;!DOCTYPE html PUBLIC &#39;-//W3C//DTD XHTML 1.0 Strict//EN&#39; &#39;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39; xml:lang=&#39;en&#39; lang=&#39;en&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=utf-8&#39; /&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;title&gt;fastcgi++: SQL Database example&lt;/title&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;h2&gt;Showing &quot;</span> &lt;&lt; m_query.results()-&gt;data.size() &lt;&lt; <span class="stringliteral">&quot; results out of &quot;</span> &lt;&lt; m_query.rows() &lt;&lt; <span class="stringliteral">&quot;&lt;/h2&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;table&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;tr&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&lt;b&gt;IP Address&lt;/b&gt;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&lt;b&gt;Timestamp&lt;/b&gt;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&lt;b&gt;Session ID&lt;/b&gt;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&lt;b&gt;Referral&lt;/b&gt;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;/tr&gt;\n&quot;</span>;</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">for</span>(LogContainer::iterator it(m_query.results()-&gt;data.begin()); it!=m_query.results()-&gt;data.end(); ++it)</div>
<div class="line">         {</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;\</span></div>
<div class="line"><span class="stringliteral">         &lt;tr&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&quot;</span> &lt;&lt; it-&gt;ipAddress &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&quot;</span> &lt;&lt; it-&gt;timestamp &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&quot;</span> &lt;&lt; it-&gt;sessionId &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            &lt;td&gt;&quot;</span> &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca42e00febc19b44c59cfdde409c8a7cb6">HTML</a>) &lt;&lt; it-&gt;referral &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca1824f8debfcb8164867fd6a229a017a2">NONE</a>) &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;/tr&gt;\n&quot;</span>;</div>
<div class="line">         }</div>
<div class="line"></div>
<div class="line">         out &lt;&lt; <span class="stringliteral">&quot;\</span></div>
<div class="line"><span class="stringliteral">      &lt;/table&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;p&gt;&lt;a href=&#39;database.fcgi&#39;&gt;Refer Me&lt;/a&gt;&lt;/p&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;/html&gt;&quot;</span>;</div>
<div class="line"></div>
<div class="line">         <a class="code" href="a00048.html" title="Class for storing query data to be passed to and retrieved from statements.">ASql::Query&lt;ASql::Data::SetBuilder&lt;Log&gt;</a>, <span class="keywordtype">void</span>&gt; insertQuery;</div>
<div class="line">         insertQuery.createParameters();</div>
<div class="line">         insertQuery.<a class="code" href="a00056.html#a2a3777584fa3a4124a039bc9adf3c7d0" title="Set true if you want the query to not be cancelled when the original object is destroyed.">keepAlive</a>(<span class="keyword">true</span>);</div>
<div class="line">         insertQuery.<a class="code" href="a00056.html#a5ff5ddd8e8f3a624753391ef3a0b4ed3" title="Return a void pointer to the parameter set.">parameters</a>()-&gt;data.ipAddress = environment().remoteAddress;</div>
<div class="line">         insertQuery.<a class="code" href="a00056.html#a5ff5ddd8e8f3a624753391ef3a0b4ed3" title="Return a void pointer to the parameter set.">parameters</a>()-&gt;data.timestamp = boost::posix_time::second_clock::universal_time();</div>
<div class="line">         <span class="keywordflow">if</span>(environment().referer.size())</div>
<div class="line">            insertQuery.<a class="code" href="a00056.html#a5ff5ddd8e8f3a624753391ef3a0b4ed3" title="Return a void pointer to the parameter set.">parameters</a>()-&gt;data.referral = environment().referer;</div>
<div class="line"></div>
<div class="line">         <a class="code" href="a00048.html" title="Class for storing query data to be passed to and retrieved from statements.">ASql::Query&lt;IpAddress, void&gt;</a> updateQuery;</div>
<div class="line">         updateQuery.createParameters().data = environment().remoteAddress;</div>
<div class="line">         updateQuery.<a class="code" href="a00056.html#a2a3777584fa3a4124a039bc9adf3c7d0" title="Set true if you want the query to not be cancelled when the original object is destroyed.">keepAlive</a>(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">         <a class="code" href="a00082.html" title="Build a series of queries into a transaction.">ASql::MySQL::Transaction</a> transaction;</div>
<div class="line">         transaction.<a class="code" href="a00082.html#ae0b6f182abf8e73c74b42e22280ce3ba" title="Add a query to the transaction.">push</a>(insertQuery, insertStatement);</div>
<div class="line">         transaction.<a class="code" href="a00082.html#ae0b6f182abf8e73c74b42e22280ce3ba" title="Add a query to the transaction.">push</a>(updateQuery, updateStatement);</div>
<div class="line">         transaction.<a class="code" href="a00082.html#a29d61d0790664a9d801317951435f4b9" title="Initiate the transaction.">start</a>();</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">      }</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">try</span></div>
<div class="line">   {</div>
<div class="line">      Database::initSql();</div>
<div class="line">      <a class="code" href="a00039.html" title="General task and protocol management class.">Fastcgipp::Manager&lt;Database&gt;</a> fcgi;</div>
<div class="line">      fcgi.<a class="code" href="a00039.html#a578c8468166d892d1858ad6f4d953d8d" title="General handling function to be called after construction.">handler</a>();</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">catch</span>(std::exception&amp; e)</div>
<div class="line">   {</div>
<div class="line">      error_log(e.what());</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 22 2012 20:35:53 for fastcgi++ by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1
</small></address>
</body>
</html>
