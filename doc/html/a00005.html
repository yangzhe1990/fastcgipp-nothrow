<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>fastcgi++: Sessions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">fastcgi++
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">index</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Sessions </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sessionsTutorial"></a>
Tutorial</h1>
<p>Our goal here will be a FastCGI application that has very simple session capabilities. We won't authenticate the creation of sessions, and the only data we will store in them is a user supplied text string. Be warned that the facilities that fastcgi++ supplies for handling sessions are quite low level to allow for maximum customizability and no overhead costs if they aren't used.</p>
<p>All code and data is located in the examples directory of the tarball. You'll have to compile with: <code>pkg-config &ndash;libs &ndash;cflags fastcgi++</code></p>
<h2><a class="anchor" id="sessionsError"></a>
Error Logging</h2>
<p>Our first step will be setting up an error logging system. Although requests can log errors directly to the HTTP server error log, I like to have an error logging system that's separate from the library when testing applications. Let's set up a function that takes a c style string and logs it to a file with a timestamp. Since everyone has access to the /tmp directory, I set it up to send error messages to /tmp/errlog. You can change it if you want to.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> error_log(<span class="keyword">const</span> <span class="keywordtype">char</span>* msg)</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">using namespace </span>std;</div>
<div class="line">   <span class="keyword">using namespace </span>boost;</div>
<div class="line">   <span class="keyword">static</span> ofstream error;</div>
<div class="line">   <span class="keywordflow">if</span>(!error.is_open())</div>
<div class="line">   {</div>
<div class="line">      error.open(<span class="stringliteral">&quot;/tmp/errlog&quot;</span>, ios_base::out | ios_base::app);</div>
<div class="line">      error.imbue(locale(error.getloc(), <span class="keyword">new</span> posix_time::time_facet()));</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   error &lt;&lt; <span class="charliteral">&#39;[&#39;</span> &lt;&lt; posix_time::second_clock::local_time() &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; msg &lt;&lt; endl;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="sessionsRequest"></a>
Request Handler</h2>
<p>Now we need to write the code that actually handles the request. Quite simply, all we need to do is derive from <a class="el" href="a00059.html" title="Request handling class">Fastcgipp::Request</a> and define the <a class="el" href="a00059.html#ab20544d056d5f288bca354b8c996e451" title="Response generator.">Fastcgipp::Request::response()</a> function. For this example we'll just use ISO-8859-1 as the character set so we'll pass char as the template parameter to the Request class as opposed to wchar_t.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00110.html" title="Defines the Fastcgipp::Request class.">fastcgi++/request.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>SessionExample: <span class="keyword">public</span> <a class="code" href="a00059.html" title="Request handling class">Fastcgipp::Request</a>&lt;char&gt;</div>
<div class="line">{</div>
</div><!-- fragment --><p>The first thing we are going to do here is set up a typedef to make accessing our sessions container easier. Sessions are contained in the <a class="el" href="a00063.html" title="Container for HTTP sessions.">Fastcgipp::Http::Sessions</a> container which in almost all ways is just an std::map. The template parameter that the class takes is any data type you want to associate with the session. Typically someone might associate a struct that contains user ids and access level with each sessions. In this example we will just use a string. The passed template type ends up as the second type in the std::pair&lt;&gt; of the std::map. The first type will always be a type <a class="el" href="a00062.html" title="Defines ID values for HTTP sessions.">Fastcgipp::Http::SessionId</a> which is a class for managing session id with their expiries effectively.</p>
<div class="fragment"><div class="line">   <span class="keyword">typedef</span> <a class="code" href="a00063.html" title="Container for HTTP sessions.">Fastcgipp::Http::Sessions&lt;std::string&gt;</a> Sessions;</div>
</div><!-- fragment --><p>Now let's define our actual session data in the class. We need to declare two items: a static Sessions container and a non-static iterator for the container. The iterator will obviously point to the session data pair associate with this particular request.</p>
<div class="fragment"><div class="line">   <span class="keyword">static</span> Sessions sessions;</div>
<div class="line">   Sessions::iterator session;</div>
</div><!-- fragment --><p>Now we can define our response function. It is this function that is called to generate a response for the client. It isn't a good idea to define the response() function inline as it is called from numerous spots, but for the examples readability we will make an exception.</p>
<div class="fragment"><div class="line">   <span class="keywordtype">bool</span> response()</div>
<div class="line">   {</div>
<div class="line">      <span class="keyword">using namespace </span>Fastcgipp;</div>
</div><!-- fragment --><p>First off let's clean up any expired sessions. Calling this function at the beginning of every request actually doesn't create all that much overhead as is explained later on.</p>
<div class="fragment"><div class="line">      sessions.cleanup();</div>
</div><!-- fragment --><p>Now we need to initialize the session data member. In this example we will do this by finding a session id passed to us from the client as a cookie. You could also use get data instead of cookies obviously. Let's call our session cookie SESSIONID. Remember that our cookies/GET data is stored in a <a class="el" href="a00022.html" title="Data structure of HTTP environment data.">Fastcgipp::Http::Environment</a> object called environment().</p>
<div class="fragment"><div class="line">      session=sessions.find(environment().findCookie(<span class="stringliteral">&quot;SESSIONID&quot;</span>).data());</div>
</div><!-- fragment --><p>Now the session data member will be a valid iterator to a session or it will point to end() if the client didn't provide a session id or it was invalid.</p>
<p>In order to get login/logout commands from the client we will use GET information. A simple ?command=login/logout system will suffice.</p>
<div class="fragment"><div class="line">      std::string command=environment().gets[<span class="stringliteral">&quot;command&quot;</span>];</div>
</div><!-- fragment --><p>Now we're going to need to set our locale to output boost::date_time stuff in a proper cookie expiry way. See <a class="el" href="a00059.html#a10bf656234f3434bbc8f8702fa1a9af4" title="Set the requests locale.">Fastcgipp::Request::setloc()</a>.</p>
<div class="fragment"><div class="line">      setloc(std::locale(getloc(), <span class="keyword">new</span> boost::posix_time::time_facet(<span class="stringliteral">&quot;%a, %d-%b-%Y %H:%M:%S GMT&quot;</span>)));</div>
</div><!-- fragment --><p>Now we do what needs to be done if we received valid session data.</p>
<div class="fragment"><div class="line">      <span class="keywordflow">if</span>(session!=sessions.end())</div>
<div class="line">      {</div>
<div class="line">         <span class="keywordflow">if</span>(command==<span class="stringliteral">&quot;logout&quot;</span>)</div>
<div class="line">         {</div>
</div><!-- fragment --><p>If we received a logout command then we need to delete the cookie, remove the session data from the container, reset our session iterator, and then send the response.</p>
<div class="fragment"><div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Set-Cookie: SESSIONID=deleted; expires=Thu, 01-Jan-1970 00:00:00 GMT;\n&quot;</span>;</div>
<div class="line">            sessions.erase(session);</div>
<div class="line">            session=sessions.end();</div>
<div class="line">            handleNoSession();</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">         {</div>
</div><!-- fragment --><p>Otherwise, we just call <a class="el" href="a00062.html#ae97803294898c3039eb42490e4176f03" title="Resets the last access timestamp to the current time.">Fastcgipp::Http::SessionId::refresh()</a> on our session ID to update the expiry time, update it on the client side and then do the response.</p>
<div class="fragment"><div class="line">            session-&gt;first.refresh();</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Set-Cookie: SESSIONID=&quot;</span> &lt;&lt; encoding(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca2f746f6e9c773c1d71fc9a54ea13bce2">URL</a>) &lt;&lt; session-&gt;first &lt;&lt; encoding(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca1824f8debfcb8164867fd6a229a017a2">NONE</a>) &lt;&lt; <span class="stringliteral">&quot;; expires=&quot;</span> &lt;&lt; sessions.getExpiry(session) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">            handleSession();</div>
<div class="line">         }</div>
<div class="line">      }</div>
</div><!-- fragment --><p>With no valid session id from the client it is even easier.</p>
<div class="fragment"><div class="line">      <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">         <span class="keywordflow">if</span>(command==<span class="stringliteral">&quot;login&quot;</span>)</div>
<div class="line">         {</div>
</div><!-- fragment --><p>Since the client wants to make a new session, we call <a class="el" href="a00063.html#afe9099eedbfc37a07fe4b9b0fdb018d2" title="Generates a new session pair with a random ID value.">Fastcgipp::Http::Sessions::generate()</a>. This function will generate a new random session id and associated the passed session data with it. Calling a stream insertion operation on <a class="el" href="a00062.html" title="Defines ID values for HTTP sessions.">Fastcgipp::Http::SessionId</a> will output a base64 encoding of the id value. Perfect for http communications. To coordinate, constructing the class from a char* / wchar_t* will assume the string is base64 encoded and decode it accordingly.</p>
<div class="fragment"><div class="line">            session=sessions.generate(environment().posts[<span class="stringliteral">&quot;data&quot;</span>].value);</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Set-Cookie: SESSIONID=&quot;</span> &lt;&lt; encoding(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca2f746f6e9c773c1d71fc9a54ea13bce2">URL</a>) &lt;&lt; session-&gt;first &lt;&lt; encoding(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca1824f8debfcb8164867fd6a229a017a2">NONE</a>) &lt;&lt; <span class="stringliteral">&quot;; expires=&quot;</span> &lt;&lt; sessions.getExpiry(session) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">            handleSession();</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">            handleNoSession();</div>
<div class="line">      }</div>
</div><!-- fragment --><p>Now we can output some basic stuff that will be sent regardless of whether we are in a session or not.</p>
<div class="fragment"><div class="line">      out &lt;&lt; <span class="stringliteral">&quot;&lt;p&gt;There are &quot;</span> &lt;&lt; sessions.size() &lt;&lt; <span class="stringliteral">&quot; sessions open&lt;/p&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;/html&gt;&quot;</span>;</div>
</div><!-- fragment --><p>And we're basically done defining our response! All we need to do is return a boolean value. Always return true if you are done. This will let apache and the manager know we are done so they can destroy the request and free it's resources. Return false if you are not finished but want to relinquish control and allow other requests to operate. You would do this if the request needed to wait for a message to be passed back to it through the task manager.</p>
<div class="fragment"><div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">   }</div>
</div><!-- fragment --><p>Now we can define the functions that generate a response whether in session or not.</p>
<div class="fragment"><div class="line">   <span class="keywordtype">void</span> handleSession()</div>
<div class="line">   {</div>
<div class="line">      <span class="keyword">using namespace </span>Fastcgipp;</div>
<div class="line">      out &lt;&lt; <span class="stringliteral">&quot;\</span></div>
<div class="line"><span class="stringliteral">Content-Type: text/html; charset=ISO-8859-1\r\n\r\n\</span></div>
<div class="line"><span class="stringliteral">&lt;!DOCTYPE html PUBLIC &#39;-//W3C//DTD XHTML 1.0 Strict//EN&#39; &#39;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39; xml:lang=&#39;en&#39; lang=&#39;en&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=ISO-8859-1&#39; /&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;title&gt;fastcgi++: Session Handling example&lt;/title&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;p&gt;We are currently in a session. The session id is &quot;</span> &lt;&lt; session-&gt;first &lt;&lt; <span class="stringliteral">&quot; and the session data is \&quot;&quot;</span> &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca42e00febc19b44c59cfdde409c8a7cb6">HTML</a>) &lt;&lt; session-&gt;second &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca1824f8debfcb8164867fd6a229a017a2">NONE</a>) &lt;&lt; <span class="stringliteral">&quot;\&quot;. It will expire at &quot;</span> &lt;&lt; sessions.getExpiry(session) &lt;&lt; <span class="stringliteral">&quot;.&lt;/p&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;p&gt;Click &lt;a href=&#39;?command=logout&#39;&gt;here&lt;/a&gt; to logout&lt;/p&gt;\n&quot;</span>;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   <span class="keywordtype">void</span> handleNoSession()</div>
<div class="line">   {</div>
<div class="line">      out &lt;&lt; <span class="stringliteral">&quot;\</span></div>
<div class="line"><span class="stringliteral">Content-Type: text/html; charset=ISO-8859-1\r\n\r\n\</span></div>
<div class="line"><span class="stringliteral">&lt;!DOCTYPE html PUBLIC &#39;-//W3C//DTD XHTML 1.0 Strict//EN&#39; &#39;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39; xml:lang=&#39;en&#39; lang=&#39;en&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=ISO-8859-1&#39; /&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;title&gt;fastcgi++: Session Handling example&lt;/title&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;p&gt;We are currently not in a session.&lt;/p&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;form action=&#39;?command=login&#39; method=&#39;post&#39; enctype=&#39;multipart/form-data&#39; accept-charset=&#39;ISO-8859-1&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;div&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            Text: &lt;input type=&#39;text&#39; name=&#39;data&#39; value=&#39;Hola señor, usted me almacenó en una sesión&#39; /&gt; \n\</span></div>
<div class="line"><span class="stringliteral">            &lt;input type=&#39;submit&#39; name=&#39;submit&#39; value=&#39;submit&#39; /&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;/div&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;/form&gt;\n&quot;</span>;</div>
<div class="line">   }</div>
<div class="line">};</div>
</div><!-- fragment --><p>Now let's initialize the static sessions object. The constructor takes to parameters. The first defines how many seconds session live for without an refresh. The second defines the minimum number of seconds that have to pass between cleanups of old sessions. This means that if the value is 30 two calls to Fastcgipp::Sessions::cleanup() in a 30 second period will only actually preform the cleanup once. We'll go 30 seconds for each in this example.</p>
<div class="fragment"><div class="line">Session::Sessions Session::sessions(30, 30);</div>
</div><!-- fragment --><h2><a class="anchor" id="sessionsManager"></a>
Requests Manager</h2>
<p>Now we need to make our main() function. Really all one needs to do is create a <a class="el" href="a00039.html" title="General task and protocol management class.">Fastcgipp::Manager</a> object with the new class we made as a template parameter, then call it's handler. Let's go one step further though and set up a try/catch loop in case we get any exceptions and log them with our error_log function.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00102.html" title="Defines the Fastcgipp::Manager class.">fastcgi++/manager.hpp</a>&gt;</span></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">try</span></div>
<div class="line">   {</div>
<div class="line">      <a class="code" href="a00039.html" title="General task and protocol management class.">Fastcgipp::Manager&lt;SessionExample&gt;</a> fcgi;</div>
<div class="line">      fcgi.<a class="code" href="a00039.html#a578c8468166d892d1858ad6f4d953d8d" title="General handling function to be called after construction.">handler</a>();</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">catch</span>(std::exception&amp; e)</div>
<div class="line">   {</div>
<div class="line">      error_log(e.what());</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --><p>And that's it! About as simple as it gets.</p>
<h1><a class="anchor" id="sessionsCode"></a>
Full Source Code</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00110.html" title="Defines the Fastcgipp::Request class.">fastcgi++/request.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="a00102.html" title="Defines the Fastcgipp::Manager class.">fastcgi++/manager.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> error_log(<span class="keyword">const</span> <span class="keywordtype">char</span>* msg)</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">using namespace </span>std;</div>
<div class="line">   <span class="keyword">using namespace </span>boost;</div>
<div class="line">   <span class="keyword">static</span> ofstream error;</div>
<div class="line">   <span class="keywordflow">if</span>(!error.is_open())</div>
<div class="line">   {</div>
<div class="line">      error.open(<span class="stringliteral">&quot;/tmp/errlog&quot;</span>, ios_base::out | ios_base::app);</div>
<div class="line">      error.imbue(locale(error.getloc(), <span class="keyword">new</span> posix_time::time_facet()));</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   error &lt;&lt; <span class="charliteral">&#39;[&#39;</span> &lt;&lt; posix_time::second_clock::local_time() &lt;&lt; <span class="stringliteral">&quot;] &quot;</span> &lt;&lt; msg &lt;&lt; endl;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>Session: <span class="keyword">public</span> <a class="code" href="a00059.html" title="Request handling class">Fastcgipp::Request</a>&lt;char&gt;</div>
<div class="line">{</div>
<div class="line">   <span class="keyword">typedef</span> <a class="code" href="a00063.html" title="Container for HTTP sessions.">Fastcgipp::Http::Sessions&lt;std::string&gt;</a> Sessions;</div>
<div class="line">   <span class="keywordtype">bool</span> response()</div>
<div class="line">   {</div>
<div class="line">      <span class="keyword">using namespace </span>Fastcgipp;</div>
<div class="line">      sessions.<a class="code" href="a00063.html#abf5eef3ab4c056ac62b923dfd9c7c3ad" title="Clean out old sessions.">cleanup</a>();</div>
<div class="line"></div>
<div class="line">      session=sessions.find(environment().findCookie(<span class="stringliteral">&quot;SESSIONID&quot;</span>).data());</div>
<div class="line">      </div>
<div class="line">      <span class="keyword">const</span> std::string&amp; command=environment().findGet(<span class="stringliteral">&quot;command&quot;</span>);</div>
<div class="line">      </div>
<div class="line">      setloc(std::locale(getloc(), <span class="keyword">new</span> boost::posix_time::time_facet(<span class="stringliteral">&quot;%a, %d-%b-%Y %H:%M:%S GMT&quot;</span>)));</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">if</span>(session!=sessions.end())</div>
<div class="line">      {</div>
<div class="line">         <span class="keywordflow">if</span>(command==<span class="stringliteral">&quot;logout&quot;</span>)</div>
<div class="line">         {</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Set-Cookie: SESSIONID=deleted; expires=Thu, 01-Jan-1970 00:00:00 GMT;\n&quot;</span>;</div>
<div class="line">            sessions.erase(session);</div>
<div class="line">            session=sessions.end();</div>
<div class="line">            handleNoSession();</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">         {</div>
<div class="line">            session-&gt;first.refresh();</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Set-Cookie: SESSIONID=&quot;</span> &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca2f746f6e9c773c1d71fc9a54ea13bce2">URL</a>) &lt;&lt; session-&gt;first &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca1824f8debfcb8164867fd6a229a017a2">NONE</a>) &lt;&lt; <span class="stringliteral">&quot;; expires=&quot;</span> &lt;&lt; sessions.getExpiry(session) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">            handleSession();</div>
<div class="line">         }</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">         <span class="keywordflow">if</span>(command==<span class="stringliteral">&quot;login&quot;</span>)</div>
<div class="line">         {</div>
<div class="line">            session=sessions.generate(environment().findPost(<span class="stringliteral">&quot;data&quot;</span>).value);</div>
<div class="line">            out &lt;&lt; <span class="stringliteral">&quot;Set-Cookie: SESSIONID=&quot;</span> &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca2f746f6e9c773c1d71fc9a54ea13bce2">URL</a>) &lt;&lt; session-&gt;first &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca1824f8debfcb8164867fd6a229a017a2">NONE</a>) &lt;&lt; <span class="stringliteral">&quot;; expires=&quot;</span> &lt;&lt; sessions.getExpiry(session) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">            handleSession();</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">            handleNoSession();</div>
<div class="line">      }</div>
<div class="line"></div>
<div class="line">      out &lt;&lt; <span class="stringliteral">&quot;&lt;p&gt;There are &quot;</span> &lt;&lt; sessions.size() &lt;&lt; <span class="stringliteral">&quot; sessions open&lt;/p&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;/html&gt;&quot;</span>;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   <span class="keywordtype">void</span> handleSession()</div>
<div class="line">   {</div>
<div class="line">      <span class="keyword">using namespace </span>Fastcgipp;</div>
<div class="line">      out &lt;&lt; <span class="stringliteral">&quot;\</span></div>
<div class="line"><span class="stringliteral">Content-Type: text/html; charset=ISO-8859-1\r\n\r\n\</span></div>
<div class="line"><span class="stringliteral">&lt;!DOCTYPE html PUBLIC &#39;-//W3C//DTD XHTML 1.0 Strict//EN&#39; &#39;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39; xml:lang=&#39;en&#39; lang=&#39;en&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=ISO-8859-1&#39; /&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;title&gt;fastcgi++: Session Handling example&lt;/title&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;p&gt;We are currently in a session. The session id is &quot;</span> &lt;&lt; session-&gt;first &lt;&lt; <span class="stringliteral">&quot; and the session data is \&quot;&quot;</span> &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca42e00febc19b44c59cfdde409c8a7cb6">HTML</a>) &lt;&lt; session-&gt;second &lt;&lt; <a class="code" href="a00020.html" title="Stream manipulator for setting output encoding.">encoding</a>(<a class="code" href="a00118.html#a3bfe00c3bd74edb08bb2efd5f4a3714ca1824f8debfcb8164867fd6a229a017a2">NONE</a>) &lt;&lt; <span class="stringliteral">&quot;\&quot;. It will expire at &quot;</span> &lt;&lt; sessions.getExpiry(session) &lt;&lt; <span class="stringliteral">&quot;.&lt;/p&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;p&gt;Click &lt;a href=&#39;?command=logout&#39;&gt;here&lt;/a&gt; to logout&lt;/p&gt;\n&quot;</span>;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   <span class="keywordtype">void</span> handleNoSession()</div>
<div class="line">   {</div>
<div class="line">      <span class="keyword">using namespace </span>Fastcgipp;</div>
<div class="line">      out &lt;&lt; <span class="stringliteral">&quot;\</span></div>
<div class="line"><span class="stringliteral">Content-Type: text/html; charset=ISO-8859-1\r\n\r\n\</span></div>
<div class="line"><span class="stringliteral">&lt;!DOCTYPE html PUBLIC &#39;-//W3C//DTD XHTML 1.0 Strict//EN&#39; &#39;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">&lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39; xml:lang=&#39;en&#39; lang=&#39;en&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=ISO-8859-1&#39; /&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;title&gt;fastcgi++: Session Handling example&lt;/title&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;/head&gt;\n\</span></div>
<div class="line"><span class="stringliteral">   &lt;body&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;p&gt;We are currently not in a session.&lt;/p&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;form action=&#39;?command=login&#39; method=&#39;post&#39; enctype=&#39;application/x-www-form-urlencoded&#39; accept-charset=&#39;ISO-8859-1&#39;&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;div&gt;\n\</span></div>
<div class="line"><span class="stringliteral">            Text: &lt;input type=&#39;text&#39; name=&#39;data&#39; value=&#39;Hola señor, usted me almacenó en una sesión&#39; /&gt; \n\</span></div>
<div class="line"><span class="stringliteral">            &lt;input type=&#39;submit&#39; name=&#39;submit&#39; value=&#39;submit&#39; /&gt;\n\</span></div>
<div class="line"><span class="stringliteral">         &lt;/div&gt;\n\</span></div>
<div class="line"><span class="stringliteral">      &lt;/form&gt;\n&quot;</span>;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   <span class="keyword">static</span> Sessions sessions;</div>
<div class="line">   Sessions::iterator session;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">Session::Sessions Session::sessions(30, 30);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">try</span></div>
<div class="line">   {</div>
<div class="line">      <a class="code" href="a00039.html" title="General task and protocol management class.">Fastcgipp::Manager&lt;Session&gt;</a> fcgi;</div>
<div class="line">      fcgi.<a class="code" href="a00039.html#a578c8468166d892d1858ad6f4d953d8d" title="General handling function to be called after construction.">handler</a>();</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">catch</span>(std::exception&amp; e)</div>
<div class="line">   {</div>
<div class="line">      error_log(e.what());</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 22 2012 20:35:53 for fastcgi++ by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1
</small></address>
</body>
</html>
